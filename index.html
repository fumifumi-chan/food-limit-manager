<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>賞味期限管理</title>

    <!-- Alpine.js -->
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <link rel="stylesheet" href="style.css" />
  </head>

  <body
    x-data="app()"
    x-init="loadData()"
    @submit-data.window="saveItem($event.detail)"
  >
    <header>賞味期限管理</header>

    <main>
      <!-- 読み込み中表示 -->
      <div x-show="loading" x-transition.opacity class="loading-overlay">
        <div class="loading-box">
          <div class="spinner"></div>
          <p>読み込み中...</p>
        </div>
      </div>
      <!-- 入力フォーム -->
      <div class="card">
        <div x-data="foodForm()">
          <!-- 商品名 -->
          <label>商品名</label>
          <input type="text" placeholder="食品名" x-model="name" required />

          <!-- カテゴリ選択 -->
          <label>カテゴリ</label>
          <select x-model="category" @change="applyGrace()">
            <option value="">選択してください</option>
            <template x-for="(days, name) in categories" :key="name">
              <option :value="name" x-text="name"></option>
            </template>
          </select>

          <!-- 賞味・消費期限 -->
          <label>期限</label>
          <input type="date" x-model="expireDate" required />

          <!-- 猶予日数 -->
          <label>猶予日数（必要な場合のみ変更）</label>
          <input type="number" x-model.number="graceDays" />

          <button @click="submit()">追加</button>
        </div>
      </div>

      <!-- フィルター -->
      <div class="card">
        <label> このあたりにフィルタボタンを配置 </label>
      </div>

      <!-- 一覧 -->
      <div class="list">
        <template x-for="item in items" :key="item.id">
          <div class="item" :class="{ expired: isExpired(item) }">
            <strong x-text="item.name"></strong>
            <div>
              期限：<span x-text="item.expireDate"></span>
              <span class="tag" x-text="item.category"></span>
            </div>

            <!-- <div x-show="item.ignore" style="color: #ef4444; font-size: 12px">
              ※期限切れ許容
            </div> -->
          </div>
        </template>
      </div>
    </main>

    <script>
      const API =
        'https://script.google.com/macros/s/AKfycbw8qNC_5N97lnovPQOG2GeoRRG4a4t6Rwl2INOb8Lu12IHq6g6d2nCIlCqI02aWfLeeLg/exec';
      const KEY = 'x8KpT2F7mH6z9NqJ5Cw4YB3Z0sE1LrOaDVXcIikUuStQyRdbGMnhPeWfAj';

      const GRACE_BY_CATEGORY = {
        肉・魚: 0,
        惣菜: 0,
        乳製品: 2,
        卵: 7,
        野菜・果物: 3,
        調味料: 180,
        缶詰: 365,
        乾物: 365,
        レトルト: 180,
        お菓子: 30,
        飲料: 7,
        その他: 0,
      };

      function app() {
        return {
          items: [],

          loading: false,

          async loadData() {
            this.loading = true;
            try {
              const data = await fetch(`${API}?key=${KEY}`).then((r) =>
                r.json(),
              );

              // 日付をYYYY-MM-DD形式にしてから保存
              this.items = data.map((item) => ({
                ...item,
                expireDate: this.formatDateOnly(item.expiry),
                category: item.category,
              }));
            } catch (e) {
              alert('通信に失敗しました。もう一度操作をやり直してください。');
              console.error(e);
            } finally {
              this.loading = false;
            }
          },

          async saveItem(payload) {
            this.loading = true;
            try {
              console.log(payload);
              await fetch(`${API}?key=${KEY}`, {
                method: 'POST',
                body: JSON.stringify({
                  name: payload.name,
                  expireDate: payload.expireDate,
                  category: payload.category,
                  graceDays: payload.graceDays,
                }),
                // CORSエラー対策
                // NOTE: headersを指定しなくても、勝手にヘッダがついて引っかかる模様
                mode: 'no-cors',
              });
              await this.loadData();
            } finally {
              this.loading = false;
            }
          },

          // 賞味期限切れかどうか
          isExpired(item) {
            return new Date(item.expiry) < new Date();
          },

          // YYYY/MM/DD形式に変換する
          formatDateOnly(iso) {
            return new Date(iso).toLocaleDateString('ja-JP', {
              timeZone: 'Asia/Tokyo',
            });
          },
        };
      }

      function foodForm() {
        return {
          name: '',
          expireDate: '',
          category: '',
          graceDays: 0,

          categories: GRACE_BY_CATEGORY,

          applyGrace() {
            if (this.category) {
              this.graceDays = this.categories[this.category];
            }
          },

          validate() {
            if (!this.name.trim()) return '商品名を入力してください';
            if (!this.expireDate) return '賞味期限を入力してください';
            return null;
          },

          async submit() {
            const err = this.validate();
            if (err) {
              alert(err);
              return;
            }

            const payload = {
              name: this.name.trim(),
              expireDate: this.expireDate,
              category: this.category,
              graceDays: this.graceDays,
            };

            this.$dispatch('submit-data', payload);

            this.reset();
          },

          reset() {
            this.name = '';
            this.expireDate = '';
            this.category = '';
            this.graceDays = '';
          },
        };
      }
    </script>
  </body>
</html>
