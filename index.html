<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è³å‘³æœŸé™ç®¡ç†</title>

    <!-- Alpine.js -->
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <link rel="stylesheet" href="style.css" />
  </head>

  <body
    x-data="app()"
    x-init="loadData()"
    @submit-data.window="addItem($event.detail)"
  >
    <header>è³å‘³æœŸé™ç®¡ç†</header>

    <main>
      <!-- èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤º -->
      <div x-show="loading" x-transition.opacity class="loading-overlay">
        <div class="loading-box">
          <div class="spinner"></div>
          <p>èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
      <div
        class="modal"
        x-show="editTarget"
        x-transition
        @click.self="editTarget=null"
      >
        <div class="modal-content">
          <h3>ç·¨é›†</h3>

          <input x-model="editTarget.name" placeholder="å•†å“å" />
          <input type="date" x-model="editTarget.expireDate" />

          <div class="buttons">
            <button @click="saveEdit()">ä¿å­˜</button>
            <button @click="editTarget=null">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      </div>

      <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="card">
        <div x-data="foodForm()">
          <!-- å•†å“å -->
          <label>å•†å“å</label>
          <input type="text" placeholder="é£Ÿå“å" x-model="name" required />

          <!-- ã‚«ãƒ†ã‚´ãƒªé¸æŠ -->
          <label>ã‚«ãƒ†ã‚´ãƒª</label>
          <select x-model="category" @change="applyGrace()">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <template x-for="(days, name) in categories" :key="name">
              <option :value="name" x-text="name"></option>
            </template>
          </select>

          <!-- è³å‘³ãƒ»æ¶ˆè²»æœŸé™ -->
          <label>æœŸé™</label>
          <input type="date" x-model="expireDate" required />

          <!-- çŒ¶äºˆæ—¥æ•° -->
          <label>çŒ¶äºˆæ—¥æ•°ï¼ˆå¿…è¦ãªå ´åˆã®ã¿å¤‰æ›´ï¼‰</label>
          <input type="number" x-model.number="graceDays" />

          <!-- ãƒ¡ãƒ¢ -->
          <label>ãƒ¡ãƒ¢</label>
          <input type="text" placeholder="ãƒ¡ãƒ¢" x-model.number="memo" />

          <button @click="submit()">è¿½åŠ </button>
        </div>
      </div>

      <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      <!-- <div class="card">
        <label> ã“ã®ã‚ãŸã‚Šã«ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³ã‚’é…ç½® </label>
      </div> -->

      <!-- ä¸€è¦§ -->
      <div class="list">
        <template x-for="item in items" :key="item.id">
          <div class="item" :class="{ expired: isExpired(item) }">
            <div class="item-header">
              <strong x-text="item.name"></strong>

              <div class="actions">
                <!-- <button class="icon-btn" @click="openEdit(item)" title="ç·¨é›†">
                  âœï¸
                </button> -->
                <button
                  class="icon-btn delete"
                  @click="deleteItem(item)"
                  title="å‰Šé™¤"
                >
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>

            <!-- <div x-show="item.ignore" style="color: #ef4444; font-size: 12px">
                â€»æœŸé™åˆ‡ã‚Œè¨±å®¹
              </div> -->
            <div>
              æœŸé™ï¼š<span x-text="formatDate(item.expireDate)"></span>
              <span class="tag" x-text="item.category"></span>
            </div>
          </div>
        </template>
      </div>
    </main>

    <script>
      const API =
        'https://script.google.com/macros/s/AKfycbw8qNC_5N97lnovPQOG2GeoRRG4a4t6Rwl2INOb8Lu12IHq6g6d2nCIlCqI02aWfLeeLg/exec';
      const KEY = 'x8KpT2F7mH6z9NqJ5Cw4YB3Z0sE1LrOaDVXcIikUuStQyRdbGMnhPeWfAj';

      const GRACE_BY_CATEGORY = {
        è‚‰ãƒ»é­š: 0,
        æƒ£èœ: 0,
        ä¹³è£½å“: 2,
        åµ: 7,
        é‡èœãƒ»æœç‰©: 3,
        èª¿å‘³æ–™: 180,
        ç¼¶è©°: 365,
        ä¹¾ç‰©: 365,
        ãƒ¬ãƒˆãƒ«ãƒˆ: 180,
        ãŠè“å­: 30,
        é£²æ–™: 7,
        ãã®ä»–: 0,
      };

      function app() {
        return {
          items: [],

          loading: false,

          // ç·¨é›†å¯¾è±¡ã®ã‚¢ã‚¤ãƒ†ãƒ 
          editTarget: null,

          async loadData() {
            this.loading = true;
            try {
              const data = await fetch(`${API}?key=${KEY}`).then((r) =>
                r.json(),
              );

              // æ—¥ä»˜ã‚’YYYY-MM-DDå½¢å¼ã«ã—ã¦ã‹ã‚‰ä¿å­˜
              this.items = data
                .map((item) => {
                  const d = new Date(item.expireDate);
                  return {
                    ...item,
                    expireDate: isNaN(d) ? '' : d.toISOString().slice(0, 10),
                    category: item.category,
                  };
                })
                .sort(
                  (a, b) => new Date(a.expireDate) - new Date(b.expireDate),
                );
            } catch (e) {
              alert('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦æ“ä½œã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚');
              console.error(e);
            } finally {
              this.loading = false;
            }
          },

          async addItem(payload) {
            // UUIDç”Ÿæˆ
            const id = crypto.randomUUID();

            // UIã¸åæ˜ 
            const item = {
              id,
              name: payload.name,
              expireDate: payload.expireDate,
              category: payload.category,
              graceDays: payload.graceDays,
              rebuy: false,
              memo: payload.memo,
            };

            this.items.unshift(item);

            try {
              console.log(payload);
              console.log(item);
              const res = await fetch(`${API}?key=${KEY}`, {
                method: 'POST',
                body: JSON.stringify({
                  action: 'add',
                  ...item,
                }),
                // CORSã‚¨ãƒ©ãƒ¼å¯¾ç­–
                // NOTE: headersã‚’æŒ‡å®šã—ãªãã¦ã‚‚ã€å‹æ‰‹ã«ãƒ˜ãƒƒãƒ€ãŒã¤ã„ã¦å¼•ã£ã‹ã‹ã‚‹æ¨¡æ§˜
                mode: 'no-cors',
              });
            } catch (e) {
              console.error(e);

              // å¤±æ•—æ™‚ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
              this.items = this.items.filter((i) => i.id !== id);
              alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          },

          // è³å‘³æœŸé™åˆ‡ã‚Œã‹ã©ã†ã‹
          isExpired(item) {
            return new Date(item.expireDate) < new Date();
          },

          // YYYY/MM/DDå½¢å¼ã«å¤‰æ›ã™ã‚‹
          formatDate(date) {
            return new Date(date).toLocaleDateString('ja-JP', {
              timeZone: 'Asia/Tokyo',
            });
          },

          // ç·¨é›†ç”»é¢ã‚’é–‹ã
          async openEdit(item) {
            console.log(item);
            console.log(item.name);
            this.editTarget = JSON.parse(JSON.stringify(item));
          },

          // ã‚¢ã‚¤ãƒ†ãƒ ã®å‰Šé™¤
          async deleteItem(item) {
            if (!confirm(`ã€Œ${item.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            const backup = [...this.items];

            this.items = this.items.filter((i) => i.id != item.id);

            try {
              await fetch(`${API}?key=${KEY}`, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                  action: 'delete',
                  id: item.id,
                }),
              });
            } catch (e) {
              console.log(e);

              // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
              this.items = backup;
              alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
          },

          async saveEdit(edited) {
            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ï¼‰
            const backup = JSON.parse(JSON.stringify(this.items));

            const idx = this.items.findIndex((i) => i.id === edited.id);
            if (idx !== -1) {
              this.items[idx] = { ...edited };
            }

            try {
              await fetch(`${API}?key=${KEY}`, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                  action: 'update',
                  ...edited,
                }),
              });
            } catch (e) {
              console.error(e);

              // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
              this.items = backup;
              alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          },
        };
      }

      function foodForm() {
        return {
          name: '',
          expireDate: '',
          category: '',
          graceDays: 0,
          rebuy: false,
          memo: '',

          categories: GRACE_BY_CATEGORY,

          applyGrace() {
            if (this.category) {
              this.graceDays = this.categories[this.category];
            }
          },

          validate() {
            if (!this.name.trim()) return 'å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
            if (!this.expireDate) return 'è³å‘³æœŸé™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
            return null;
          },

          async submit() {
            const err = this.validate();
            if (err) {
              alert(err);
              return;
            }

            const payload = {
              name: this.name.trim(),
              expireDate: this.expireDate,
              category: this.category,
              graceDays: this.graceDays,
              rebuy: this.rebuy,
              memo: this.memo,
            };

            this.$dispatch('submit-data', payload);

            this.reset();
          },

          reset() {
            this.name = '';
            this.expireDate = '';
            this.category = '';
            this.graceDays = '';
            this.rebuy = false;
            this.memo = '';
          },
        };
      }
    </script>
  </body>
</html>
